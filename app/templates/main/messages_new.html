{% extends "base.html" %} {% block title %}Chat with {{ other_user.username }} -
TechBuddy{% endblock %} {% block styles %}
<!-- Quill Rich Text Editor CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
<style>
  .ql-container {
    font-size: 14px;
  }
  .ql-editor {
    min-height: 80px;
    max-height: 200px;
    overflow-y: auto;
  }
  .ql-editor.ql-blank::before {
    color: #9ca3af;
    font-style: normal;
  }
  .ql-toolbar.ql-snow {
    border: 1px solid #cbd5e1;
    border-bottom: none;
    border-radius: 0.5rem 0.5rem 0 0;
    background: #f8fafc;
  }
  .ql-container.ql-snow {
    border: 1px solid #cbd5e1;
    border-radius: 0 0 0.5rem 0.5rem;
  }
  #richTextEditor {
    display: none;
  }
  #richTextEditor.active {
    display: block;
  }
  #plainTextArea {
    display: block;
  }
  #plainTextArea.hidden {
    display: none;
  }
  .message-content h1 {
    font-size: 1.5em;
    font-weight: bold;
    margin: 0.5em 0;
  }
  .message-content h2 {
    font-size: 1.3em;
    font-weight: bold;
    margin: 0.5em 0;
  }
  .message-content h3 {
    font-size: 1.1em;
    font-weight: bold;
    margin: 0.5em 0;
  }
  .message-content strong {
    font-weight: bold;
  }
  .message-content em {
    font-style: italic;
  }
  .message-content u {
    text-decoration: underline;
  }
  .message-content ul {
    list-style: disc;
    margin-left: 1.5em;
  }
  .message-content ol {
    list-style: decimal;
    margin-left: 1.5em;
  }
  .message-content blockquote {
    border-left: 3px solid #cbd5e1;
    padding-left: 1em;
    margin: 0.5em 0;
    opacity: 0.8;
  }
  .message-content pre {
    background: #1e293b;
    color: #e2e8f0;
    padding: 0.5em;
    border-radius: 0.25rem;
    overflow-x: auto;
  }
  .message-content code {
    background: #1e293b;
    color: #e2e8f0;
    padding: 0.125rem 0.25rem;
    border-radius: 0.125rem;
    font-family: monospace;
    font-size: 0.875em;
  }
  .message-content a {
    color: #3b82f6;
    text-decoration: underline;
  }
</style>
{% endblock %} {% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
  <div
    class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden"
  >
    <!-- Chat Header -->
    <div class="border-b border-slate-200 p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <a
            href="{{ url_for('main.matches') }}"
            class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 transition"
          >
            <i class="fas fa-arrow-left text-slate-600"></i>
          </a>

          {% if other_user.profile.profile_photo %}
          <img
            src="{{ url_for('static', filename='uploads/' + other_user.profile.profile_photo) }}"
            class="w-12 h-12 rounded-full object-cover border-2 border-blue-500"
            alt="{{ other_user.username }}"
          />
          {% else %}
          <div
            class="w-12 h-12 rounded-full bg-blue-600 flex items-center justify-center"
          >
            <span class="text-white font-semibold"
              >{{ other_user.username[0].upper() }}</span
            >
          </div>
          {% endif %}

          <div>
            <h2 class="font-semibold text-slate-900">
              {{ other_user.username }}
            </h2>
            {% if other_user.profile.current_role %}
            <p class="text-sm text-slate-600">
              {{ other_user.profile.current_role }}
            </p>
            {% endif %}
            <p id="typingIndicator" class="text-xs text-blue-600 hidden">
              <i class="fas fa-circle-notch fa-spin mr-1"></i>typing...
            </p>
          </div>
        </div>

        <a
          href="{{ url_for('main.view_profile', user_id=other_user.id) }}"
          class="px-4 py-2 border border-slate-300 rounded-lg text-sm font-medium hover:bg-slate-50 transition"
        >
          View Profile
        </a>
      </div>
    </div>

    <!-- Messages Container -->
    <div
      id="messagesContainer"
      class="h-[500px] overflow-y-auto p-6 space-y-4 bg-slate-50"
    >
      {% if messages %} {% for message in messages %} {% if not
      message.is_deleted %}
      <div
        class="flex {% if message.sender_id == current_user.id %}justify-end{% else %}justify-start{% endif %}"
        data-message-id="{{ message.id }}"
      >
        <div class="max-w-[70%] group relative">
          <!-- Message Content -->
          <div
            class="{% if message.sender_id == current_user.id %}bg-blue-600 text-white{% else %}bg-white text-slate-900 border border-slate-200{% endif %} rounded-2xl overflow-hidden"
          >
            {% if message.message_type == 'image' %}
            <!-- Image Message -->
            <div class="p-2">
              <img
                src="{{ url_for('static', filename='uploads/' + message.file_url) }}"
                class="max-w-full rounded-lg cursor-pointer hover:opacity-90 transition"
                onclick="openImageModal(this.src)"
                alt="Shared image"
              />
              {% if message.content %}
              <div class="message-content mt-2 px-2">
                {% if message.is_rich_text %} {{ message.content|safe }} {% else
                %}
                <p class="text-sm">{{ message.content }}</p>
                {% endif %}
              </div>
              {% endif %}
            </div>

            {% elif message.message_type == 'voice' %}
            <!-- Voice Note -->
            <div class="p-3">
              <div class="flex items-center space-x-3">
                <button
                  onclick="playVoiceNote('{{ message.id }}')"
                  class="w-10 h-10 rounded-full {% if message.sender_id == current_user.id %}bg-blue-500{% else %}bg-blue-600{% endif %} flex items-center justify-center hover:opacity-80 transition"
                >
                  <i
                    class="fas fa-play text-white text-sm"
                    id="play-icon-{{ message.id }}"
                  ></i>
                </button>
                <audio
                  id="audio-{{ message.id }}"
                  src="{{ url_for('static', filename='uploads/' + message.file_url) }}"
                  preload="metadata"
                ></audio>
                <div class="flex-1">
                  <div class="h-8 flex items-center">
                    <i class="fas fa-microphone mr-2"></i>
                    <span class="text-sm">Voice Note</span>
                  </div>
                  <div
                    class="text-xs opacity-75"
                    id="duration-{{ message.id }}"
                  >
                    0:00
                  </div>
                </div>
              </div>
              {% if message.content %}
              <div class="message-content mt-2">
                {% if message.is_rich_text %} {{ message.content|safe }} {% else
                %}
                <p class="text-sm">{{ message.content }}</p>
                {% endif %}
              </div>
              {% endif %}
            </div>

            {% elif message.message_type == 'video' %}
            <!-- Video Message -->
            <div class="p-2">
              <video controls class="max-w-full rounded-lg">
                <source
                  src="{{ url_for('static', filename='uploads/' + message.file_url) }}"
                />
                Your browser does not support the video tag.
              </video>
              {% if message.content %}
              <div class="message-content mt-2 px-2">
                {% if message.is_rich_text %} {{ message.content|safe }} {% else
                %}
                <p class="text-sm">{{ message.content }}</p>
                {% endif %}
              </div>
              {% endif %}
            </div>

            {% elif message.message_type == 'file' %}
            <!-- File Attachment -->
            <div class="p-3">
              <a
                href="{{ url_for('static', filename='uploads/' + message.file_url) }}"
                download="{{ message.file_name }}"
                class="flex items-center space-x-3 hover:opacity-80 transition"
              >
                <div
                  class="w-10 h-10 rounded-lg {% if message.sender_id == current_user.id %}bg-blue-500{% else %}bg-blue-600{% endif %} flex items-center justify-center"
                >
                  <i class="fas fa-file text-white"></i>
                </div>
                <div class="flex-1">
                  <p class="text-sm font-medium truncate">
                    {{ message.file_name }}
                  </p>
                  <p class="text-xs opacity-75">
                    {{ (message.file_size / 1024)|round(1) }} KB
                  </p>
                </div>
                <i class="fas fa-download"></i>
              </a>
              {% if message.content %}
              <div class="message-content mt-2">
                {% if message.is_rich_text %} {{ message.content|safe }} {% else
                %}
                <p class="text-sm">{{ message.content }}</p>
                {% endif %}
              </div>
              {% endif %}
            </div>

            {% else %}
            <!-- Text Message -->
            <div class="px-4 py-3 message-content">
              {% if message.is_rich_text %} {{ message.content|safe }} {% else
              %}
              <p class="text-sm whitespace-pre-wrap">{{ message.content }}</p>
              {% endif %}
            </div>
            {% endif %} {% if message.reaction %}
            <div
              class="absolute -bottom-2 right-2 bg-white border border-slate-200 rounded-full px-2 py-1 text-xs shadow-sm"
            >
              {{ message.reaction }}
            </div>
            {% endif %}
          </div>

          <!-- Message Actions -->
          <div
            class="flex items-center mt-1 space-x-2 {% if message.sender_id == current_user.id %}justify-end{% endif %}"
          >
            <p class="text-xs text-slate-500">
              {{ message.sent_at.strftime('%I:%M %p') }} {% if message.sender_id
              == current_user.id and message.is_read %}
              <i class="fas fa-check-double text-blue-500 ml-1"></i>
              {% endif %}
            </p>

            <!-- Reaction Button -->
            <div class="opacity-0 group-hover:opacity-100 transition-opacity">
              <button
                onclick="showReactionPicker({{ message.id }})"
                class="text-slate-400 hover:text-slate-600 transition"
              >
                <i class="far fa-smile text-xs"></i>
              </button>
              {% if message.sender_id == current_user.id %}
              <button
                onclick="deleteMessage({{ message.id }})"
                class="text-slate-400 hover:text-red-600 transition ml-1"
              >
                <i class="far fa-trash-alt text-xs"></i>
              </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endif %} {% endfor %} {% else %}
      <div class="text-center py-12">
        <div
          class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mx-auto mb-3"
        >
          <i class="fas fa-comment text-slate-400 text-2xl"></i>
        </div>
        <p class="text-slate-600">No messages yet. Start the conversation!</p>
      </div>
      {% endif %}
    </div>

    <!-- Message Input -->
    <div class="border-t border-slate-200 p-4 bg-white">
      <form
        method="POST"
        action="{{ url_for('main.messages', user_id=other_user.id) }}"
        enctype="multipart/form-data"
        id="messageForm"
        class="space-y-3"
      >
        {{ form.hidden_tag() }} {{ form.is_rich_text(id="isRichTextInput") }}

        <!-- File Preview -->
        <div id="filePreview" class="hidden">
          <div
            class="bg-slate-100 rounded-lg p-3 flex items-center justify-between"
          >
            <div class="flex items-center space-x-3">
              <i class="fas fa-file text-blue-600"></i>
              <span id="fileName" class="text-sm text-slate-700"></span>
            </div>
            <button
              type="button"
              onclick="clearFile()"
              class="text-slate-400 hover:text-slate-600"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <div class="flex space-x-2 items-start">
          <!-- Attachment Button -->
          <label for="attachment" class="cursor-pointer flex-shrink-0">
            <div
              class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 transition text-slate-600"
            >
              <i class="fas fa-paperclip"></i>
            </div>
          </label>
          {{ form.attachment(class="hidden", id="attachment",
          onchange="handleFileSelect(this)") }}

          <!-- Voice Note Button -->
          <button
            type="button"
            id="voiceButton"
            onclick="toggleRecording()"
            class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg hover:bg-slate-100 transition text-slate-600"
          >
            <i class="fas fa-microphone"></i>
          </button>

          <!-- Rich Text Toggle Button -->
          <button
            type="button"
            id="richTextToggle"
            onclick="toggleRichText()"
            class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg hover:bg-slate-100 transition text-slate-600"
            title="Toggle Rich Text Editor"
          >
            <i class="fas fa-font"></i>
          </button>

          <!-- Message Input Area -->
          <div class="flex-1">
            <!-- Plain Text Area -->
            <div id="plainTextArea">
              {{ form.content(class="w-full px-4 py-3 border border-slate-300
              rounded-lg focus:outline-none focus:border-blue-500 transition
              resize-none", rows="1", id="contentTextarea", placeholder="Type
              your message...", onkeydown="handleTyping(event)",
              oninput="autoResize(this)") }}
            </div>

            <!-- Rich Text Editor (Hidden by default) -->
            <div id="richTextEditor">
              <div id="quillEditor"></div>
            </div>
          </div>

          {{ form.submit(class="px-6 py-3 flex-shrink-0 bg-blue-600 text-white
          rounded-lg font-semibold hover:bg-blue-700 transition cursor-pointer")
          }}
        </div>

        <!-- Editor Mode Indicator -->
        <div id="editorModeIndicator" class="text-xs text-slate-500 hidden">
          <i class="fas fa-info-circle mr-1"></i>
          <span id="modeText">Rich text mode active</span>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div
  id="imageModal"
  class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4"
  onclick="closeImageModal()"
>
  <img
    id="modalImage"
    class="max-w-full max-h-full rounded-lg"
    alt="Full size image"
  />
  <button
    onclick="closeImageModal()"
    class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300"
  >
    <i class="fas fa-times"></i>
  </button>
</div>

<!-- Reaction Picker -->
<div
  id="reactionPicker"
  class="hidden fixed bg-white border border-slate-200 rounded-lg shadow-lg p-3 z-50"
>
  <div class="flex space-x-2">
    <button
      onclick="addReaction('‚ù§Ô∏è')"
      class="text-2xl hover:scale-125 transition"
    >
      ‚ù§Ô∏è
    </button>
    <button
      onclick="addReaction('üòä')"
      class="text-2xl hover:scale-125 transition"
    >
      üòä
    </button>
    <button
      onclick="addReaction('üòÇ')"
      class="text-2xl hover:scale-125 transition"
    >
      üòÇ
    </button>
    <button
      onclick="addReaction('üòÆ')"
      class="text-2xl hover:scale-125 transition"
    >
      üòÆ
    </button>
    <button
      onclick="addReaction('üëç')"
      class="text-2xl hover:scale-125 transition"
    >
      üëç
    </button>
    <button
      onclick="addReaction('üî•')"
      class="text-2xl hover:scale-125 transition"
    >
      üî•
    </button>
  </div>
</div>
{% endblock %} {% block scripts %}
<!-- Quill Rich Text Editor JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
  let mediaRecorder;
  let audioChunks = [];
  let currentMessageId = null;
  let quill = null;
  let isRichTextMode = false;

  // Initialize Quill Editor
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize Quill
    quill = new Quill("#quillEditor", {
      theme: "snow",
      placeholder: "Type your formatted message...",
      modules: {
        toolbar: [
          [{ header: [1, 2, 3, false] }],
          ["bold", "italic", "underline", "strike"],
          [{ color: [] }, { background: [] }],
          [{ list: "ordered" }, { list: "bullet" }],
          ["blockquote", "code-block"],
          ["link"],
          ["clean"],
        ],
      },
    });

    // Auto-scroll to bottom on page load
    const container = document.getElementById("messagesContainer");
    container.scrollTop = container.scrollHeight;

    // Load audio durations
    document.querySelectorAll("audio").forEach((audio) => {
      audio.addEventListener("loadedmetadata", function () {
        const id = this.id.replace("audio-", "");
        const minutes = Math.floor(this.duration / 60);
        const seconds = Math.floor(this.duration % 60);
        document.getElementById(
          `duration-${id}`
        ).textContent = `${minutes}:${seconds.toString().padStart(2, "0")}`;
      });
    });

    // Handle form submission
    document
      .getElementById("messageForm")
      .addEventListener("submit", function (e) {
        if (isRichTextMode) {
          const html = quill.root.innerHTML;
          const text = quill.getText().trim();

          if (
            text.length > 0 ||
            document.getElementById("attachment").files.length > 0
          ) {
            document.getElementById("contentTextarea").value = html;
          } else {
            e.preventDefault();
            return false;
          }
        }
      });
  });

  // Toggle Rich Text Editor
  function toggleRichText() {
    isRichTextMode = !isRichTextMode;
    const richTextEditor = document.getElementById("richTextEditor");
    const plainTextArea = document.getElementById("plainTextArea");
    const toggleButton = document.getElementById("richTextToggle");
    const modeIndicator = document.getElementById("editorModeIndicator");
    const isRichTextInput = document.getElementById("isRichTextInput");

    if (isRichTextMode) {
      // Switch to rich text
      const plainText = document.getElementById("contentTextarea").value;
      quill.root.innerHTML = plainText;

      richTextEditor.classList.add("active");
      plainTextArea.classList.add("hidden");
      toggleButton.classList.add("bg-blue-100", "text-blue-600");
      modeIndicator.classList.remove("hidden");
      isRichTextInput.value = "true";
      quill.focus();
    } else {
      // Switch to plain text
      const richText = quill.getText();
      document.getElementById("contentTextarea").value = richText;

      richTextEditor.classList.remove("active");
      plainTextArea.classList.remove("hidden");
      toggleButton.classList.remove("bg-blue-100", "text-blue-600");
      modeIndicator.classList.add("hidden");
      isRichTextInput.value = "false";
      document.getElementById("contentTextarea").focus();
    }
  }

  // Auto-resize textarea
  function autoResize(textarea) {
    textarea.style.height = "auto";
    textarea.style.height = textarea.scrollHeight + "px";
  }

  // Typing indicator
  let typingTimeout;
  function handleTyping(event) {
    clearTimeout(typingTimeout);

    fetch(`/api/typing/{{ other_user.id }}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    });

    typingTimeout = setTimeout(() => {
      // Stop typing indicator
    }, 1000);

    // Submit on Enter (without Shift)
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      document.getElementById("messageForm").submit();
    }
  }

  // File handling
  function handleFileSelect(input) {
    const file = input.files[0];
    if (file) {
      document.getElementById("filePreview").classList.remove("hidden");
      document.getElementById("fileName").textContent = file.name;
    }
  }

  function clearFile() {
    document.getElementById("attachment").value = "";
    document.getElementById("filePreview").classList.add("hidden");
  }

  // Voice recording
  async function toggleRecording() {
    const button = document.getElementById("voiceButton");

    if (mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
      button.innerHTML = '<i class="fas fa-microphone"></i>';
      button.classList.remove("bg-red-500", "text-white");
    } else {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, {
            type: "audio/ogg; codecs=opus",
          });
          const audioFile = new File([audioBlob], `voice_${Date.now()}.ogg`, {
            type: "audio/ogg",
          });

          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(audioFile);
          document.getElementById("attachment").files = dataTransfer.files;

          handleFileSelect(document.getElementById("attachment"));

          stream.getTracks().forEach((track) => track.stop());
        };

        mediaRecorder.start();
        button.innerHTML = '<i class="fas fa-stop"></i>';
        button.classList.add("bg-red-500", "text-white");
      } catch (error) {
        console.error("Error accessing microphone:", error);
        alert("Could not access microphone. Please check permissions.");
      }
    }
  }

  // Voice note playback
  function playVoiceNote(messageId) {
    const audio = document.getElementById(`audio-${messageId}`);
    const icon = document.getElementById(`play-icon-${messageId}`);

    if (audio.paused) {
      document.querySelectorAll("audio").forEach((a) => {
        if (a !== audio) a.pause();
      });
      document.querySelectorAll('[id^="play-icon-"]').forEach((i) => {
        i.className = "fas fa-play text-white text-sm";
      });

      audio.play();
      icon.className = "fas fa-pause text-white text-sm";

      audio.onended = () => {
        icon.className = "fas fa-play text-white text-sm";
      };
    } else {
      audio.pause();
      audio.currentTime = 0;
      icon.className = "fas fa-play text-white text-sm";
    }
  }

  // Image modal
  function openImageModal(src) {
    document.getElementById("modalImage").src = src;
    document.getElementById("imageModal").classList.remove("hidden");
  }

  function closeImageModal() {
    document.getElementById("imageModal").classList.add("hidden");
  }

  // Reactions
  function showReactionPicker(messageId) {
    currentMessageId = messageId;
    const picker = document.getElementById("reactionPicker");
    const messageEl = document.querySelector(
      `[data-message-id="${messageId}"]`
    );
    const rect = messageEl.getBoundingClientRect();

    picker.style.left = `${rect.left}px`;
    picker.style.top = `${rect.bottom + 5}px`;
    picker.classList.remove("hidden");

    setTimeout(() => {
      document.addEventListener("click", closeReactionPicker);
    }, 100);
  }

  function closeReactionPicker(event) {
    const picker = document.getElementById("reactionPicker");
    if (!picker.contains(event.target)) {
      picker.classList.add("hidden");
      document.removeEventListener("click", closeReactionPicker);
    }
  }

  async function addReaction(emoji) {
    if (!currentMessageId) return;

    try {
      const response = await fetch(`/api/message/${currentMessageId}/react`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ reaction: emoji }),
      });

      if (response.ok) {
        location.reload();
      }
    } catch (error) {
      console.error("Error adding reaction:", error);
    }

    document.getElementById("reactionPicker").classList.add("hidden");
  }

  // Delete message
  async function deleteMessage(messageId) {
    if (!confirm("Delete this message?")) return;

    try {
      const response = await fetch(`/api/message/${messageId}/delete`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      });

      if (response.ok) {
        location.reload();
      }
    } catch (error) {
      console.error("Error deleting message:", error);
    }
  }
</script>
{% endblock %}
