{% extends "base.html" %} {% block title %}My Profile - TechBuddy{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
  <div
    class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm"
  >
    <!-- Header -->
    <div class="relative h-64 bg-slate-200">
      {% if current_user.profile.profile_photo %}
      <img
        src="{{ url_for('static', filename='uploads/' + current_user.profile.profile_photo) }}"
        class="w-full h-full object-cover"
        alt="{{ current_user.username }}"
      />
      {% else %}
      <div class="w-full h-full flex items-center justify-center bg-blue-100">
        <i class="fas fa-user text-blue-600 text-8xl"></i>
      </div>
      {% endif %}

      <div class="absolute bottom-4 right-4">
        <form
          action="{{ url_for('profile.upload_photo') }}"
          method="POST"
          enctype="multipart/form-data"
          id="photoForm"
        >
          <label
            for="photo"
            class="px-4 py-2 bg-white/90 backdrop-blur rounded-lg text-sm font-semibold cursor-pointer hover:bg-white transition"
          >
            <i class="fas fa-camera mr-2"></i>Change Photo
          </label>
          <input
            type="file"
            id="photo"
            name="photo"
            accept="image/*"
            class="hidden"
            onchange="document.getElementById('photoForm').submit()"
          />
        </form>
      </div>
    </div>

    <div class="p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h1 class="text-3xl font-bold text-slate-900 mb-2">
            {{ current_user.username }}
          </h1>
          <p class="text-slate-600">{{ current_user.age }} years old</p>
          <p class="text-slate-600">
            <i class="fas fa-map-marker-alt mr-1"></i>
            {{ current_user.city }}, {{ current_user.state }}, {{
            current_user.country }}
          </p>
        </div>

        <div class="flex space-x-2">
          <a
            href="{{ url_for('profile.edit_profile') }}"
            class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition"
          >
            <i class="fas fa-edit mr-2"></i>Edit Profile
          </a>
          <a
            href="{{ url_for('profile.settings') }}"
            class="px-4 py-3 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition"
          >
            <i class="fas fa-cog"></i>
          </a>
        </div>
      </div>

      <!-- Tech Info -->
      <div class="grid md:grid-cols-2 gap-4 mb-6">
        {% if current_user.profile.current_role %}
        <div class="p-4 bg-blue-50 rounded-lg">
          <p class="text-xs font-semibold text-blue-600 uppercase mb-1">
            Current Role
          </p>
          <p class="text-slate-900 font-medium">
            {{ current_user.profile.current_role }}
          </p>
        </div>
        {% endif %} {% if current_user.profile.experience_level %}
        <div class="p-4 bg-purple-50 rounded-lg">
          <p class="text-xs font-semibold text-purple-600 uppercase mb-1">
            Experience Level
          </p>
          <p class="text-slate-900 font-medium">
            {{ current_user.profile.experience_level }}
          </p>
        </div>
        {% endif %} {% if current_user.looking_for %}
        <div class="p-4 bg-cyan-50 rounded-lg">
          <p class="text-xs font-semibold text-cyan-600 uppercase mb-1">
            Looking For
          </p>
          <p class="text-slate-900 font-medium">
            {{ current_user.looking_for }}
          </p>
        </div>
        {% endif %} {% if current_user.profile.collaboration_interest %}
        <div class="p-4 bg-green-50 rounded-lg">
          <p class="text-xs font-semibold text-green-600 uppercase mb-1">
            Collaboration Interest
          </p>
          <p class="text-slate-900 font-medium">
            {{ current_user.profile.collaboration_interest }}
          </p>
        </div>
        {% endif %}
      </div>

      <!-- Bio -->
      {% if current_user.profile.bio %}
      <div class="mb-6">
        <h3 class="text-lg font-bold text-slate-900 mb-2">About</h3>
        <p class="text-slate-700">{{ current_user.profile.bio }}</p>
      </div>
      {% endif %}

      <!-- Learning Goals -->
      {% if current_user.profile.learning_goals %}
      <div class="mb-6">
        <h3 class="text-lg font-bold text-slate-900 mb-2">
          <i class="fas fa-graduation-cap text-blue-600 mr-2"></i>
          What I Want to Learn
        </h3>
        <p class="text-slate-700">{{ current_user.profile.learning_goals }}</p>
      </div>
      {% endif %}

      <!-- Can Teach -->
      {% if current_user.profile.can_teach %}
      <div class="mb-6">
        <h3 class="text-lg font-bold text-slate-900 mb-2">
          <i class="fas fa-chalkboard-teacher text-green-600 mr-2"></i>
          What I Can Teach
        </h3>
        <p class="text-slate-700">{{ current_user.profile.can_teach }}</p>
      </div>
      {% endif %}

      <!-- Links -->
      <div class="flex flex-wrap gap-3 mb-6">
        {% if current_user.profile.github_url %}
        <a
          href="{{ current_user.profile.github_url }}"
          target="_blank"
          class="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition"
        >
          <i class="fab fa-github mr-2"></i>GitHub
        </a>
        {% endif %} {% if current_user.profile.portfolio_url %}
        <a
          href="{{ current_user.profile.portfolio_url }}"
          target="_blank"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
        >
          <i class="fas fa-briefcase mr-2"></i>Portfolio
        </a>
        {% endif %} {% if current_user.profile.linkedin_url %}
        <a
          href="{{ current_user.profile.linkedin_url }}"
          target="_blank"
          class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition"
        >
          <i class="fab fa-linkedin mr-2"></i>LinkedIn
        </a>
        {% endif %}
      </div>

      <!-- AI Insights Section -->
      <div
        class="mt-8 p-6 bg-gradient-to-br from-purple-50 to-blue-50 rounded-xl border border-purple-200"
      >
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-slate-900 flex items-center">
            <i class="fas fa-sparkles text-purple-600 mr-2"></i>
            AI Profile Insights
          </h3>
          <button
            onclick="refreshInsights()"
            class="px-4 py-2 bg-white border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50 transition text-sm font-medium"
          >
            <i class="fas fa-sync-alt mr-2"></i>Refresh
          </button>
        </div>

        <div id="insightsContent">
          <div class="flex justify-center py-8">
            <i class="fas fa-circle-notch fa-spin text-4xl text-purple-600"></i>
          </div>
        </div>

        <button
          onclick="showBioEnhancer()"
          class="mt-4 w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium"
        >
          <i class="fas fa-magic mr-2"></i>Enhance My Bio with AI
        </button>
      </div>

      <!-- Account Actions -->
      <div class="border-t border-slate-200 pt-6 mt-8">
        <form
          action="{{ url_for('profile.deactivate_account') }}"
          method="POST"
          onsubmit="return confirm('Are you sure you want to deactivate your account?')"
        >
          <button
            type="submit"
            class="text-red-600 text-sm font-medium hover:text-red-700"
          >
            <i class="fas fa-exclamation-triangle mr-2"></i>Deactivate Account
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Bio Enhancer Modal -->
<div
  id="bioEnhancerModal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
>
  <div
    class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto"
  >
    <div class="p-6 border-b border-slate-200">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold flex items-center">
          <i class="fas fa-magic text-purple-600 mr-3"></i>
          AI Bio Enhancer
        </h2>
        <button
          onclick="closeBioEnhancer()"
          class="text-slate-400 hover:text-slate-600"
        >
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
    </div>

    <div class="p-6">
      <div class="mb-6">
        <label class="block text-sm font-medium text-slate-700 mb-2"
          >Current Bio</label
        >
        <textarea
          id="currentBio"
          rows="4"
          class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
          placeholder="Enter your current bio or leave empty for AI to generate one..."
        >
{{ current_user.profile.bio if current_user.profile.bio else '' }}</textarea
        >
      </div>

      <button
        onclick="enhanceBio()"
        class="w-full bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-medium text-lg"
      >
        <i class="fas fa-sparkles mr-2"></i>Generate AI Suggestions
      </button>

      <div id="bioSuggestions" class="mt-6 hidden">
        <!-- Suggestions will appear here -->
      </div>
    </div>
  </div>
</div>

<script>
  // Load insights on page load
  document.addEventListener("DOMContentLoaded", function () {
    loadProfileInsights();
  });

  async function loadProfileInsights() {
    try {
      const response = await fetch("/ai/profile-insights");
      const data = await response.json();

      if (data.success) {
        const stats = data.stats;
        const insights = data.insights;

        let html = `
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg border border-purple-200">
                            <div class="text-3xl font-bold text-purple-600">${stats.completeness}%</div>
                            <div class="text-sm text-slate-600">Profile Complete</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-purple-200">
                            <div class="text-3xl font-bold text-blue-600">${stats.matches}</div>
                            <div class="text-sm text-slate-600">Matches</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-purple-200">
                            <div class="text-3xl font-bold text-green-600">${stats.likes_received}</div>
                            <div class="text-sm text-slate-600">Likes Received</div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg border border-purple-200">
                        <h4 class="font-bold text-slate-900 mb-3 flex items-center">
                            <i class="fas fa-chart-line text-purple-600 mr-2"></i>
                            AI Analysis
                        </h4>
                        <div class="prose prose-sm max-w-none text-slate-700 whitespace-pre-wrap">${insights}</div>
                    </div>
                `;

        document.getElementById("insightsContent").innerHTML = html;
      } else {
        document.getElementById("insightsContent").innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-3"></i>
                        <p class="text-slate-600">${
                          data.error || "Failed to load insights"
                        }</p>
                        <button onclick="loadProfileInsights()" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                            Try Again
                        </button>
                    </div>
                `;
      }
    } catch (error) {
      document.getElementById("insightsContent").innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-3"></i>
                    <p class="text-slate-600">Error: ${error.message}</p>
                    <button onclick="loadProfileInsights()" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        Try Again
                    </button>
                </div>
            `;
    }
  }

  function refreshInsights() {
    document.getElementById("insightsContent").innerHTML = `
            <div class="flex justify-center py-8">
                <i class="fas fa-circle-notch fa-spin text-4xl text-purple-600"></i>
            </div>
        `;
    loadProfileInsights();
  }

  function showBioEnhancer() {
    document.getElementById("bioEnhancerModal").classList.remove("hidden");
  }

  function closeBioEnhancer() {
    document.getElementById("bioEnhancerModal").classList.add("hidden");
  }

  async function enhanceBio() {
    const currentBio = document.getElementById("currentBio").value.trim();
    const suggestionsDiv = document.getElementById("bioSuggestions");

    suggestionsDiv.classList.remove("hidden");
    suggestionsDiv.innerHTML = `
            <div class="flex justify-center py-8">
                <i class="fas fa-circle-notch fa-spin text-4xl text-purple-600"></i>
            </div>
        `;

    try {
      const response = await fetch("/ai/enhance-bio", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ bio: currentBio }),
      });

      const data = await response.json();

      if (data.success) {
        suggestionsDiv.innerHTML = `
                    <div class="space-y-4">
                        <div class="p-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl border border-purple-200">
                            <h4 class="font-bold text-slate-900 mb-3 flex items-center">
                                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                                AI Suggestions
                            </h4>
                            <div class="prose prose-sm max-w-none text-slate-700 whitespace-pre-wrap">${data.suggestions}</div>
                        </div>
                        
                        <div class="flex justify-end gap-3">
                            <button onclick="closeBioEnhancer()" class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition">
                                Close
                            </button>
                            <a href="{{ url_for('profile.edit_profile') }}" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                                Edit Profile
                            </a>
                        </div>
                    </div>
                `;
      } else {
        suggestionsDiv.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-3"></i>
                        <p class="text-slate-600">${
                          data.error || "Failed to enhance bio"
                        }</p>
                    </div>
                `;
      }
    } catch (error) {
      suggestionsDiv.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-3"></i>
                    <p class="text-slate-600">Error: ${error.message}</p>
                </div>
            `;
    }
  }
</script>

{% endblock %}
